# 09 - 规则编辑器（设计文档）

> 状态：设计（无实现细节）  
> 版本：3.0  
> 最后更新：2025-11-10

---

## 目标与范围（是什么/为什么）

- 为 md/mdc 规则提供一致的“所见即所得 + 元数据校验”编辑体验。
- 解决两类场景：
  1. 工作区内的用户规则（可直接编辑）；
  2. 全局缓存中的同步规则（默认建议复制到工作区“用户规则”后再编辑，避免下次同步覆盖）。
- 保证保存前校验、原子写入、与规则索引/预览的一致性。

不包含：具体渲染/实现代码、组件库选择、样式细节。

---

## 入口与导航

- TreeView 规则节点右键：
  - 「在编辑器中编辑」（命令：`turbo-ai-rules.editRule`）
  - 「在 VS Code 编辑器中打开源文件」（命令：`turbo-ai-rules.openRuleFile`）
- 规则详情页（03）顶部按钮：「编辑」→ 打开本页面。
- 命令面板：输入 `Turbo AI Rules: Edit Rule` 选择规则。

---

## 信息架构与布局（页面结构）

- 顶部工具栏：
  - 返回、保存、校验、预览开关、格式化、恢复到上次保存、在编辑器中打开源文件、帮助。
- 主体分栏：
  - 左侧：编辑区（支持 frontmatter + Markdown/MDC 内容）。
  - 右侧：实时预览（与 03 详情页相同渲染管线）。
- 底部状态条：
  - 脏状态、校验结果计数、保存结果与耗时。
- 侧栏（可折叠）：
  - 元数据表单视图（id/title/tags/priority/version/author/description...）。

---

## 关键流程

1. 打开

- 读取 `ParsedRule.filePath` 定位文件。
- 若文件位于“全局缓存目录”：
  - 弹窗说明“同步可能覆盖”，推荐复制为“工作区用户规则”，按钮：
    - 「复制并编辑」（默认）
    - 「直接编辑（不推荐）」
- 载入内容并解析 frontmatter，填充元数据表单。

2. 校验

- 触发时机：
  - 保存前自动；
  - 点击「校验」；
  - 实时（可配置防抖）。
- 结果：错误/警告列表（错误码：`TAI-300x`），可定位到具体字段/行。

3. 预览

- 使用与 03 详情相同的渲染逻辑，保障“所见即所得”。
- 预览滚动同步、图片/代码高亮、目录折叠。

4. 保存

- 原子写入：写入 `.tmp.<timestamp>` 成功后覆盖目标文件。
- 文件路径策略：
  - 若来源为全局缓存且选择“复制编辑”，目标位置为：`<workspace>/.turbo-ai-rules/user-rules/` 或项目约定的位置（参见存储策略）。
  - 支持「另存为用户规则」并自动分配前缀范围（遵循 `userPrefixRange`）。
- 保存后：
  - 触发索引刷新 → 树与详情联动更新；
  - 状态栏提示成功/失败（错误码 `TAI-400x/500x`）。

---

## 状态与边界

- 状态：空/加载中/已加载/已修改/保存中/已保存/保存失败/只读。
- 边界：
  - 无写权限（文件系统权限、只读文件）→ 只读模式并提示解决方案；
  - 非法 frontmatter/缺字段/重复 ID → 阻止保存并提供修复指引；
  - 与其他规则冲突 → 保存后提示并提供「查看冲突」入口（10 页面）。

---

## 交互要点

- 快捷键：
  - 保存：`Ctrl/Cmd+S`
  - 校验：`Ctrl/Cmd+Shift+V`
  - 预览开关：`Ctrl/Cmd+K V`
  - 格式化：`Shift+Alt+F`
- 撤销保护：离开页面时若有未保存更改，需确认。
- 国际化：遵循 `l10n` 方案；无硬编码文案。
- 无障碍：所有主操作可通过键盘与 ARIA 标签访问。

---

## 消息协议（概念层）

> 仅描述消息名称与含义，不包含实现细节

- `ruleEditor/open`: 打开指定规则（入参：ruleId/filePath）。
- `ruleEditor/validate`: 触发校验（出参：errors/warnings 列表）。
- `ruleEditor/preview/update`: 预览渲染更新。
- `ruleEditor/save`: 保存请求（入参：content/meta/targetPath）。
- `ruleEditor/save/result`: 保存结果（ok/err, details）。

---

## 验收标准

- 能从树/详情进入本页并看到原文内容与元数据。
- 编辑与预览一致；
- 保存具原子性；
- 校验与错误码符合规范；
- 对全局缓存文件默认提供“复制为用户规则”安全路径；
- i18n/无障碍合规。
