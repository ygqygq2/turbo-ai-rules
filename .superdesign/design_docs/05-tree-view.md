# 树视图界面设计文档

## 页面概述

**页面名称**: Rules Tree View (规则树视图)  
**页面类型**: VS Code TreeView  
**实现文件**: `src/providers/RulesTreeProvider.ts`  
**位置**: VS Code 活动栏（侧边栏）

---

## 设计目标

- 📂 分层展示规则源和规则列表
- 🎨 丰富的视觉层次和图标系统
- ⚡ 快速访问常用操作
- 📊 显示关键元数据信息
- 🖱️ 支持右键上下文菜单

---

## 页面布局

### 树结构（文件系统视图）

树视图采用**文件系统结构**，展示 Git 仓库的真实目录和文件层级，支持复选框选择：

```
🎯 AI RULES (156)                           [⚙️] [🔄] [➕] [🔍]
├─ 📦 company-rules                         main   ✓
│  ├─ � rules/                            [✓] (目录 - 全选)
│  │  ├─ 📁 auth/                          [✓] (子目录 - 全选)
│  │  │  ├─ ☑️ jwt-validation.md           🔥 HIGH • auth, security
│  │  │  └─ ☑️ oauth2-flow.md              ⚠️ MEDIUM • auth, oauth
│  │  ├─ 📁 security/                      [▣] (部分选中)
│  │  │  ├─ ☑️ input-sanitize.md           ⚠️ MEDIUM • security
│  │  │  └─ ☐ xss-prevention.md            ℹ️ LOW • security, xss
│  │  └─ 📁 style/                         [☐] (未选)
│  │     └─ ☐ naming-conventions.md        ℹ️ LOW • style
│  └─ ☐ README.md                          (非规则文件)
│
├─ 📦 personal-rules                        develop ✗
│  ├─ � typescript/                       [✓]
│  │  ├─ ☑️ strict-mode.md                 🔥 HIGH • ts, config
│  │  └─ ☑️ type-guards.md                 ⚠️ MEDIUM • ts
│  └─ 📁 react/                            [☐]
│     ├─ ☐ hooks-rules.md                  ⚠️ MEDIUM • react
│     └─ ☐ component-patterns.md           ℹ️ LOW • react, patterns
│
└─ 📦 archived-rules                        main   ⚠️ (冲突)
   ├─ 📁 legacy/                           [▣]
   │  └─ ☑️ old-patterns.md                ℹ️ LOW • legacy
   └─ ☐ CHANGELOG.md

视图切换按钮:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[📂 文件树] [📋 规则列表] [🏷️ 标签分组]

底部统计栏:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 12 已选 / 156 规则 | ✓ 2/3 源 | ⚠️ 2 冲突
```

### 视图模式

提供三种视图模式，用户可切换：

1. **文件树视图**（默认）：展示真实的文件系统结构

   - 显示目录和文件的层级关系
   - 支持复选框选择规则文件
   - 显示文件元数据（优先级、标签）

2. **规则列表视图**：扁平化规则列表（当前实现）

   - 按源分组显示所有规则
   - 无目录层级，直接显示规则

3. **标签分组视图**（Phase 3）：按标签分类
   - 按标签聚合规则
   - 跨源展示相同标签的规则

### 工具栏按钮

| 图标 | 功能          | 快捷键           | 位置 |
| ---- | ------------- | ---------------- | ---- |
| 📂   | 切换视图模式  | -                | 1    |
| ⚙️   | 管理源        | Ctrl+Shift+M     | 2    |
| 🔄   | 同步规则      | Ctrl+Shift+R     | 3    |
| ➕   | 添加源        | Ctrl+Shift+A     | 4    |
| 🔍   | 高级搜索      | Ctrl+Shift+Alt+F | 5    |
| 📊   | 显示统计      | -                | 6    |
| ☑️   | 全选/取消全选 | Ctrl+A           | 7    |

---

## 视觉设计

### 图标系统

**源节点图标**:

- 📦 `codicon-repo` - 规则源
- 🟢 绿色圆点 - 启用且已同步
- 🔴 红色圆点 - 禁用
- 🟡 黄色圆点 - 同步中
- ⚠️ 警告标志 - 有冲突

**目录节点图标**:

- 📁 `codicon-folder` - 未展开的目录
- 📂 `codicon-folder-opened` - 已展开的目录
- 使用 VS Code 原生文件夹图标样式

**文件节点图标**（根据优先级）:

- 🔥 `codicon-flame` - 高优先级（红色）
- ⚠️ `codicon-warning` - 中优先级（黄色）
- ℹ️ `codicon-info` - 低优先级（灰色）
- 📄 `codicon-file` - 无优先级标记的文件

**复选框状态**:

- ☑️ 已选中
- ☐ 未选中
- ▣ 部分选中（目录包含部分选中的子项）

### 颜色编码

```typescript
// 优先级颜色
高优先级: 'errorForeground'; // 红色
中优先级: 'editorWarning.foreground'; // 黄色
低优先级: 'descriptionForeground'; // 灰色

// 源状态
启用: 'charts.green'; // 绿色
禁用: 'errorForeground'; // 红色
同步中: 'charts.yellow'; // 黄色
```

### Tooltip 信息

**源节点 Tooltip**:

```markdown
**company-rules**  
📍 github.com/company/ai-rules  
🌿 Branch: main  
� Path: /rules  
📊 Total: 89 files | Selected: 12 rules  
✅ Status: Synced (2m ago)
```

**目录节点 Tooltip**:

```markdown
**auth/**  
📁 /rules/auth  
📊 Files: 5 | Selected: 3  
📦 Source: company-rules
```

**文件节点 Tooltip**:

```markdown
**JWT Validation Rules**  
� rules/auth/jwt-validation.md  
🔥 Priority: HIGH  
🏷️ Tags: auth, security, jwt  
📦 Source: company-rules  
✍️ Author: John Doe  
📅 Modified: 2 days ago
```

### 描述信息

**源节点描述**: `main ✓` (分支 + 状态)  
**目录节点描述**: `3/5 selected` (选中数/总数)  
**文件节点描述**: `HIGH • auth, security` (优先级 + 标签预览)

---

## 交互设计

### 右键菜单

**源节点菜单**:

```
──────────────────────────
✏️  编辑源配置
🔌  测试连接
🔄  启用/禁用切换
🗑️  删除源
──────────────────────────
☑️  全选规则
☐  取消全选
──────────────────────────
📊  查看统计
──────────────────────────
```

**目录节点菜单**:

```
──────────────────────────
☑️  选择此目录
☐  取消选择
──────────────────────────
🔍  在文件管理器中显示
──────────────────────────
```

**文件节点菜单**:

```
──────────────────────────
☑️  选择/取消选择
──────────────────────────
👁️  查看详情
📋  复制内容
📤  导出规则
✏️  在编辑器中打开
──────────────────────────
�  在文件管理器中显示
──────────────────────────
```

### 展开/折叠

- **单击箭头**: 展开/折叠节点
- **双击节点**: 展开/折叠（源和目录节点）
- **右箭头键**: 展开节点
- **左箭头键**: 折叠节点
- **全部展开/折叠**: 工具栏下拉菜单

### 复选框交互

- **单击复选框**: 切换选中状态
- **目录复选框**: 递归选中/取消所有子项
- **部分选中状态**: 目录包含部分选中的子项时显示
- **自动更新**: 子项状态变化时自动更新父级状态

### 选择和操作

- **单击节点**: 高亮显示（不影响复选框）
- **双击文件**: 打开规则详情面板
- **空格键**: 切换当前节点的复选框状态
- **Ctrl/Cmd+A**: 全选当前源的所有规则
- **拖放**: 重新排序（Phase 3 待实现）

---

## 数据结构

### 树节点类型

树视图支持四种节点类型，每种节点都有特定的展示和交互方式：

**节点类型枚举**:

- `source`: 规则源节点（根节点）
- `directory`: 目录节点（可展开）
- `file`: 文件节点（Markdown 规则文件）
- `empty`: 空状态提示节点

**节点数据结构**:

节点包含以下核心信息：

- **类型标识**: 用于区分节点类型和上下文菜单
- **显示信息**: 标题、描述、图标、tooltip
- **数据载荷**: 源配置、规则数据、文件路径等
- **状态信息**: 展开/折叠、选中状态、复选框状态
- **文件系统信息**: 绝对路径、相对路径（用于文件操作）

**复选框支持**:

- 仅文件节点和目录节点支持复选框
- 目录复选框具有三态：已选中、未选中、部分选中
- 复选框状态与配置系统同步

---

## 刷新机制

### 触发刷新的事件

1. **手动刷新**: 点击刷新按钮
2. **自动刷新**: 同步完成后
3. **配置变更**: 源配置修改后
4. **文件变更**: 监听规则文件变化

### 刷新策略

```typescript
// 防抖刷新（避免频繁重绘）
let refreshTimeout: NodeJS.Timeout;

function scheduleRefresh() {
  clearTimeout(refreshTimeout);
  refreshTimeout = setTimeout(() => {
    treeProvider.refresh();
  }, 300); // 300ms 延迟
}
```

### 性能优化

- **增量更新**: 仅刷新变更的节点
- **懒加载**: 展开时才加载子节点
- **虚拟化**: 大量规则时使用虚拟列表（VS Code 内置）

---

## 动画效果

### 节点展开/折叠

VS Code 内置动画，无需自定义。

### 同步进度指示

```
同步中:
📦 company-rules  🔄 Syncing... (67%)

同步完成:
📦 company-rules  ✅ Synced just now
```

---

## 状态管理

### 源状态

| 状态         | 图标 | 描述     |
| ------------ | ---- | -------- |
| `synced`     | ✓    | 已同步   |
| `not_synced` | ✗    | 未同步   |
| `syncing`    | 🔄   | 同步中   |
| `error`      | ❌   | 同步失败 |
| `conflict`   | ⚠️   | 有冲突   |
| `disabled`   | 🔴   | 已禁用   |

### 规则状态

| 状态       | 标识 | 描述   |
| ---------- | ---- | ------ |
| `normal`   | -    | 正常   |
| `ignored`  | 👁️   | 已忽略 |
| `conflict` | ⚠️   | 冲突   |
| `new`      | 🆕   | 新规则 |

---

### 排序规则

### 源排序

1. 启用的源在前
2. 按源名称字母顺序

### 目录和文件排序（文件树视图）

1. **目录优先**: 目录节点排在文件节点之前
2. **字母顺序**: 同级节点按名称字母顺序排列
3. **保持文件系统顺序**: 尊重文件系统的自然顺序

### 规则排序（规则列表视图）

1. 优先级高的在前（High → Medium → Low）
2. 同优先级按名称字母顺序

---

## 空状态处理

### 无源状态

```
┌─────────────────────────────┐
│                             │
│   📦 No Rule Sources        │
│                             │
│   Get started by adding     │
│   a rule source.            │
│                             │
│   [➕ Add Source]           │
│                             │
└─────────────────────────────┘
```

### 无规则状态

**文件树视图**:

```
📦 company-rules        main   ✓
   ┌─────────────────────────┐
   │ 📁 Empty directory      │
   │ [🔄 Sync Now]           │
   └─────────────────────────┘
```

**规则列表视图**:

```
📦 company-rules        main   ✓
   ┌─────────────────────────┐
   │ No rules found.         │
   │ [🔄 Sync Now]           │
   └─────────────────────────┘
```

---

## 无障碍支持

- **键盘导航**: 完整的键盘操作支持
- **屏幕阅读器**: 所有节点都有 `accessibilityInformation`
- **焦点管理**: 清晰的焦点指示

```typescript
// 节点无障碍信息
accessibilityInformation: {
  label: 'company-rules, 89 rules, synced 2 minutes ago',
  role: 'treeitem'
}
```

---

## 性能指标

- **初始加载**: < 200ms（100 个文件节点）
- **刷新速度**: < 100ms
- **滚动性能**: 60 FPS
- **内存占用**: < 10MB
- **目录展开**: < 50ms（懒加载子节点）
- **复选框切换**: < 20ms（包括状态同步）

---

## 与其他组件集成

### 与状态栏集成

- 树视图变化时更新状态栏统计
- 状态栏点击打开树视图

### 与 Webview 集成

- 右键"查看详情" → 打开 RuleDetailsWebview
- 工具栏"统计" → 打开 StatisticsWebview
- 工具栏"搜索" → 打开 SearchWebview

---

## 与配置系统的集成

### 选中状态的持久化

用户通过复选框选择的文件需要持久化到配置中：

**配置存储位置**:

- 工作区配置：`.vscode/settings.json`
- 源配置字段：`selectedFiles` 数组

**存储格式**:

- 相对路径列表（相对于源的 `subPath`）
- 示例：`["auth/jwt-validation.md", "security/input-sanitize.md"]`

**同步策略**:

- 用户切换复选框时立即保存到配置
- 源同步后保留用户的选择（增量更新）
- 文件被删除时自动从配置中移除

### 默认选择策略

当用户首次添加源时，默认选择行为：

1. **全选模式**（默认）：所有 `.md`/`.mdc` 文件默认选中
2. **手动模式**：所有文件默认不选中，用户手动选择
3. **智能模式**：根据元数据（如 `enabled: true`）自动选择

用户可在源配置中设置默认选择策略。

---

## 文件过滤规则

### 显示哪些文件

**包含规则**:

- `.md` 和 `.mdc` 文件（规则文件）
- 包含有效 frontmatter 的 Markdown 文件

**排除规则**:

- `.git/` 目录
- `node_modules/` 目录
- 隐藏文件（`.` 开头）
- 非 Markdown 文件（可配置）
- 配置中明确排除的路径

**空目录处理**:

- 不显示不包含任何规则文件的空目录
- 目录只要包含至少一个规则文件就显示

---

## 视图模式切换

### 切换行为

用户可在三种视图模式间切换：

1. **文件树视图** → **规则列表视图**:

   - 收起所有目录层级
   - 扁平化显示所有选中的规则
   - 按优先级排序

2. **规则列表视图** → **文件树视图**:

   - 恢复目录层级结构
   - 保持选中状态
   - 自动展开包含选中文件的目录

3. **任意视图** → **标签分组视图**:
   - 按标签重新组织规则
   - 跨源聚合相同标签的规则
   - 保持选中状态

### 视图状态持久化

- 当前视图模式保存到工作区状态
- 每个工作区独立记录视图偏好
- 启动时恢复上次使用的视图模式

---

_设计版本: 3.0_  
_最后更新: 2025-10-31_

## 12. 与 Rule Selector 的同步（新增）

### 当前阶段（MVP）

- Rule Selector 在 Webview 中保存选择后，通过执行命令 `turbo-ai-rules.refresh` 刷新树视图。
- 选中路径持久化在 `workspaceState.uiState.ruleSelections[sourceId]`（等待后续展示）。
- 树视图暂不渲染复选框，仅展示规则文件列表（未来升级）。

### 下一阶段（P1）

- 为目录与文件节点增加复选框（三态）。
- 当用户在侧边栏操作复选框时，发送消息：

```typescript
{ type: 'treeSelectionSync', sourceId: string, selectedPaths: string[] }
```

- Webview Rule Selector 接收后更新其内部状态并局部 diff 重绘。

### 消息防抖与一致性

- 侧边栏发出的同步消息采用 300ms 防抖，避免快速点击导致频繁刷新。
- Rule Selector 内部维护 `lastSyncedRevision`，忽略过期消息。

### 错误处理

- 若 workspaceState 超过大小限制（>10KB）导致写入失败，记录 `TAI-5003` 并通知用户“选择状态写入失败，请减少选择范围”。

### 安全

- 仅允许源的 `subPath` 下的相对路径进入选择集合；出现 `..` 的路径直接忽略并记录警告。
