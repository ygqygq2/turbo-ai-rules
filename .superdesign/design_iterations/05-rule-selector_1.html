<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>规则选择器</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        /* VS Code 主题变量 - 暗色主题默认值（用于浏览器预览）*/
        --vscode-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica,
          Arial, sans-serif;
        --vscode-font-weight: 400;
        --vscode-font-size: 13px;
        --vscode-foreground: #cccccc;
        --vscode-descriptionForeground: #8c8c8c;
        --vscode-errorForeground: #f48771;
        --vscode-editorWarning-foreground: #cca700;

        /* 背景色 */
        --vscode-editor-background: #1e1e1e;
        --vscode-editorWidget-background: #252526;
        --vscode-sideBar-background: #252526;
        --vscode-input-background: #3c3c3c;
        --vscode-panel-border: #454545;

        /* 边框 */
        --vscode-editorWidget-border: #454545;
        --vscode-input-border: #454545;
        --vscode-sideBar-border: #333333;
        --vscode-focusBorder: #007fd4;

        /* 输入框 */
        --vscode-input-foreground: #cccccc;

        /* 按钮 */
        --vscode-button-background: #0e639c;
        --vscode-button-foreground: #ffffff;
        --vscode-button-hoverBackground: #1177bb;
        --vscode-button-secondaryBackground: #3a3d41;
        --vscode-button-secondaryForeground: #ffffff;
        --vscode-button-secondaryHoverBackground: #45494e;

        /* 列表 */
        --vscode-list-hoverBackground: #2a2d2e;
        --vscode-list-activeSelectionBackground: #094771;
        --vscode-list-activeSelectionForeground: #ffffff;
        --vscode-list-inactiveSelectionBackground: #37373d;

        /* 图表颜色 */
        --vscode-charts-green: #89d185;
        --vscode-charts-blue: #75beff;
        --vscode-charts-yellow: #cca700;
        --vscode-charts-red: #f48771;
        --vscode-charts-purple: #b180d7;

        /* 其他 */
        --vscode-badge-background: #4d4d4d;
        --vscode-badge-foreground: #ffffff;
        --vscode-checkbox-background: #3c3c3c;
        --vscode-checkbox-border: #6c6c6c;
        --vscode-checkbox-foreground: #f0f0f0;
        --vscode-icon-foreground: #c5c5c5;
        --vscode-textLink-foreground: #3794ff;
        --vscode-toolbar-hoverBackground: #2a2d2e;

        /* 间距系统 */
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --border-radius: 4px;
        --tree-node-height: 32px;
        --control-height: 32px; /* 统一控件高度：按钮/输入框 */
        --tree-indent: 24px;
      }

      body {
        background-color: var(--vscode-editor-background);
        color: var(--vscode-foreground);
        font-family: 'Inter', var(--vscode-font-family);
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      .card {
        background-color: var(--vscode-editorWidget-background);
        border-bottom: 1px solid var(--vscode-editorWidget-border, var(--vscode-panel-border));
        flex-shrink: 0;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--spacing-md);
        height: 48px;
      }
      .header h1 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
      }
      .header .description {
        color: var(--vscode-descriptionForeground);
        margin-left: var(--spacing-sm);
      }

      .toolbar {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: 0 var(--spacing-md);
        min-height: 40px;
      }
      .search-wrapper {
        position: relative;
        flex-grow: 0;
        width: clamp(240px, 38vw, 420px);
      }
      .search-wrapper svg,
      .search-wrapper i {
        position: absolute;
        left: var(--spacing-sm);
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        color: var(--vscode-descriptionForeground);
      }
      .search-input {
        width: 100%;
        background-color: var(--vscode-input-background);
        color: var(--vscode-input-foreground);
        border: 1px solid var(--vscode-input-border);
        border-radius: var(--border-radius);
        height: var(--control-height);
        line-height: calc(var(--control-height) - 2px);
        padding: 0 var(--spacing-sm) 0 30px; /* 留出搜索图标空间 */
      }

      .stats-bar {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: 0 var(--spacing-md);
        height: 32px;
        font-size: 0.8rem;
        color: var(--vscode-descriptionForeground);
      }
      .stats-bar strong {
        color: var(--vscode-foreground);
        font-weight: 600;
      }

      .tree-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: var(--spacing-sm);
      }
      .tree-node {
        display: flex;
        align-items: center;
        height: var(--tree-node-height);
        padding-left: calc(var(--indent-level, 0) * var(--tree-indent));
        border-radius: var(--border-radius);
        cursor: pointer;
      }
      .tree-node:hover {
        background-color: var(--vscode-list-hoverBackground);
      }
      .tree-node .chevron,
      .tree-node .spacer {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
        margin-right: var(--spacing-xs);
        transition: transform 0.1s ease-in-out;
      }
      .tree-node.collapsed .chevron {
        transform: rotate(-90deg);
      }
      .tree-node .checkbox {
        width: 16px;
        height: 16px;
        border: 1px solid var(--vscode-input-border);
        border-radius: var(--border-radius);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: var(--spacing-sm);
        background-color: var(--vscode-input-background);
      }
      .tree-node .checkbox i {
        width: 14px;
        height: 14px;
        color: var(--vscode-button-foreground);
      }
      .tree-node.checked .checkbox,
      .tree-node.indeterminate .checkbox {
        background-color: var(--vscode-button-background);
        border-color: var(--vscode-button-background);
      }
      .tree-node .node-icon {
        margin-right: var(--spacing-sm);
        color: var(--vscode-descriptionForeground);
      }
      .tree-node .node-label {
        flex-grow: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .tree-node .rule-count {
        font-size: 0.8rem;
        color: var(--vscode-descriptionForeground);
        margin-left: var(--spacing-sm);
        padding-right: var(--spacing-sm);
      }

      .footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        height: 48px;
        border-top: 1px solid var(--vscode-editorWidget-border, var(--vscode-panel-border));
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 0 14px;
        border-radius: var(--border-radius);
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 13px;
        font-weight: 400;
        white-space: nowrap;
        height: var(--control-height);
        line-height: calc(var(--control-height) - 2px);
      }
      .btn:hover {
        opacity: 0.9;
      }
      .btn svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
        display: block;
      }
      .btn span {
        display: inline-block;
        line-height: 1;
      }
      .btn-primary {
        background-color: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
      }
      .btn-primary:hover {
        background-color: var(--vscode-button-hoverBackground);
      }
      .btn-secondary {
        background-color: var(--vscode-button-secondaryBackground);
        color: var(--vscode-button-secondaryForeground);
        border-color: var(--vscode-input-border);
      }
      .btn-secondary:hover {
        background-color: var(--vscode-button-secondaryHoverBackground);
      }
    </style>
  </head>
  <body>
    <div class="card header">
      <h1>选择同步规则 <span class="description">来源 "Company Coding Rules"</span></h1>
      <button class="btn" style="background: transparent" title="关闭">
        <i data-lucide="x"></i>
      </button>
    </div>

    <div class="card toolbar">
      <div class="search-wrapper">
        <i data-lucide="search"></i>
        <input type="text" class="search-input" placeholder="搜索目录或文件名..." />
      </div>
      <button class="btn btn-secondary" title="全选">
        <i data-lucide="check-square"></i>
        <span>全选</span>
      </button>
      <button class="btn btn-secondary" title="清除">
        <i data-lucide="square"></i>
        <span>清除</span>
      </button>
      <button class="btn btn-secondary" title="重置">
        <i data-lucide="rotate-ccw"></i>
        <span>重置</span>
      </button>
    </div>

    <div class="card stats-bar">
      <span>总规则: <strong>156</strong></span>
      <span>已选: <strong>120</strong></span>
      <span>排除: <strong>36</strong></span>
    </div>

    <div class="tree-container">
      <!-- 规则树区域，待实现：当前为占位示意，实际由扩展端数据驱动渲染 -->
      <!-- Root Directory (Partially selected) -->
      <div class="tree-node indeterminate" style="--indent-level: 0">
        <i data-lucide="chevron-down" class="chevron"></i>
        <div class="checkbox"><i data-lucide="minus-square"></i></div>
        <i data-lucide="folder" class="node-icon"></i>
        <span class="node-label">company-coding-rules.git</span>
      </div>

      <!-- Directory 1 (Fully selected) -->
      <div class="tree-node checked" style="--indent-level: 1">
        <i data-lucide="chevron-down" class="chevron"></i>
        <div class="checkbox"><i data-lucide="check"></i></div>
        <i data-lucide="folder" class="node-icon"></i>
        <span class="node-label">best-practices</span>
      </div>
      <div class="tree-node checked" style="--indent-level: 2">
        <span class="spacer"></span>
        <div class="checkbox"><i data-lucide="check"></i></div>
        <i data-lucide="file-text" class="node-icon"></i>
        <span class="node-label">react-hooks.mdc</span>
        <span class="rule-count">5 rules</span>
      </div>
      <div class="tree-node checked" style="--indent-level: 2">
        <span class="spacer"></span>
        <div class="checkbox"><i data-lucide="check"></i></div>
        <i data-lucide="file-text" class="node-icon"></i>
        <span class="node-label">typescript-types.mdc</span>
        <span class="rule-count">12 rules</span>
      </div>

      <!-- Directory 2 (Partially selected) -->
      <div class="tree-node indeterminate collapsed" style="--indent-level: 1">
        <i data-lucide="chevron-down" class="chevron"></i>
        <div class="checkbox"><i data-lucide="minus-square"></i></div>
        <i data-lucide="folder" class="node-icon"></i>
        <span class="node-label">style-guides</span>
      </div>
      <!-- Children of Directory 2 would be hidden because of 'collapsed' class -->

      <!-- Directory 3 (Unselected) -->
      <div class="tree-node" style="--indent-level: 1">
        <i data-lucide="chevron-down" class="chevron"></i>
        <div class="checkbox"></div>
        <i data-lucide="folder" class="node-icon"></i>
        <span class="node-label">deprecated</span>
      </div>
      <div class="tree-node" style="--indent-level: 2">
        <span class="spacer"></span>
        <div class="checkbox"></div>
        <i data-lucide="file-text" class="node-icon"></i>
        <span class="node-label">old-rules.mdc</span>
        <span class="rule-count">21 rules</span>
      </div>

      <!-- Root file -->
      <div class="tree-node checked" style="--indent-level: 1">
        <span class="spacer"></span>
        <div class="checkbox"><i data-lucide="check"></i></div>
        <i data-lucide="file-text" class="node-icon"></i>
        <span class="node-label">README.md</span>
        <span class="rule-count">1 rule</span>
      </div>
    </div>

    <div class="footer">
      <button class="btn btn-secondary">取消</button>
      <button class="btn btn-primary">保存</button>
    </div>

    <script>
      lucide.createIcons();

      const vscode = acquireVsCodeApi();

      // --- Event Listeners ---
      document.querySelectorAll('.tree-node').forEach((node) => {
        const chevron = node.querySelector('.chevron');
        if (chevron) {
          chevron.addEventListener('click', (e) => {
            e.stopPropagation();
            node.classList.toggle('collapsed');
          });
        }
      });

      document.querySelector('.footer .btn-primary').addEventListener('click', () => {
        vscode.postMessage({ command: 'saveRuleSelection', selection: { paths: ['...'] } });
      });

      document.querySelector('.footer .btn-secondary').addEventListener('click', () => {
        vscode.postMessage({ command: 'cancel' });
      });

      // --- Initial Load ---
      window.addEventListener('load', () => {
        vscode.postMessage({ command: 'loadRuleTree', sourceId: 'source-abc123' });
      });

      window.addEventListener('message', (event) => {
        const message = event.data;
        switch (message.type) {
          case 'treeData':
            // Logic to render the tree dynamically would go here
            console.log('Received tree data:', message.data);
            break;
        }
      });
    </script>
  </body>
</html>
