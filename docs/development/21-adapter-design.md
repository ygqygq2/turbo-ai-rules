# 适配器设计

> 本文档描述 Turbo AI Rules 的适配器架构、接口设计和扩展机制。

---

## 1. 适配器架构

### 1.1 适配器的作用

适配器是 Turbo AI Rules 的核心扩展点，负责：

- 将通用规则格式转换为 AI 工具特定格式
- 处理不同 AI 工具的配置文件位置和命名
- 支持自定义规则模板和渲染逻辑
- 提供工具特定的优化和增强

### 1.2 适配器分类

```
┌────────────────────────────────────────────────────┐
│              AIToolAdapter (基类)                  │
│  • 定义通用接口和抽象方法                         │
│  • 提供默认实现和辅助方法                         │
└────────────────────────────────────────────────────┘
                      ↓
    ┌─────────────────┴─────────────────┐
    ↓                                     ↓
┌─────────────────────┐      ┌─────────────────────┐
│   内置适配器        │      │   自定义适配器       │
│ • CursorAdapter     │      │ • CustomAdapter     │
│ • CopilotAdapter    │      │   (用户提供模板)    │
│ • ContinueAdapter   │      │                     │
└─────────────────────┘      └─────────────────────┘
```

---

## 2. 适配器基类 (AIToolAdapter)

### 2.1 核心职责

- 定义适配器接口和生命周期
- 提供通用的规则过滤和排序逻辑
- 处理错误和日志记录
- 支持配置验证和默认值

### 2.2 关键方法

- `generate(rules: ParsedRule[]): string` - 生成配置内容
- `getTargetFile(): string` - 返回目标文件路径
- `validate(config: AdapterConfig): ValidationResult` - 验证配置
- `shouldEnable(): boolean` - 判断是否应启用
- `formatRules(rules: ParsedRule[]): ParsedRule[]` - 格式化规则

### 2.3 生命周期钩子

- `beforeGenerate()` - 生成前的准备工作
- `afterGenerate()` - 生成后的清理工作
- `onError(error: Error)` - 错误处理

---

## 3. 内置适配器

### 3.1 适配器通用配置

所有适配器（内置和自定义）共享以下配置字段：

- `enabled`: 是否启用（默认 false）
- `autoUpdate`: 是否自动更新配置文件（默认 true）
- `includeMetadata`: 是否在生成的文件中包含元数据（可选）
- `isRuleType`: 是否是规则类型（默认 true，skills 类设为 false 不参与规则同步页）

**isRuleType 字段说明**：

- `true`（默认）：适配器参与规则同步页，用户可为其分配规则
- `false`：适配器不参与规则同步页（如 skills 类型），有独立的同步逻辑

### 3.2 CursorAdapter

**目标文件**: `.cursorrules`

**特性**:

- 支持 Markdown 格式
- 支持分段规则（用 `---` 分隔）
- 自动添加元数据注释
- 支持优先级排序

**配置项**:

```json
{
  "turboAiRules.adapters.cursor": {
    "enabled": true,
    "autoUpdate": true,
    "template": "default",
    "includeMetadata": true
  }
}
```

### 3.3 CopilotAdapter

**目标文件**: `.github/copilot-instructions.md`

**特性**:

- 符合 GitHub Copilot 格式要求
- 支持多语言规则
- 自动分类和索引
- 支持代码块语法高亮

**配置项**:

```json
{
  "turboAiRules.adapters.copilot": {
    "enabled": true,
    "autoUpdate": true,
    "language": "en",
    "includeExamples": true
  }
}
```

### 3.4 ContinueAdapter

**目标文件**: `.continuerules`

**特性**:

- 支持 Continue.dev 特有语法
- 支持规则分组
- 支持条件规则（基于文件类型）
- 支持嵌入式代码片段

**配置项**:

```json
{
  "turboAiRules.adapters.continue": {
    "enabled": true,
    "autoUpdate": true,
    "groupByCategory": true,
    "includeCodeSnippets": true
  }
}
```

---

## 4. 自定义适配器 (CustomAdapter)

### 4.1 使用场景

- 团队内部的自定义 AI 工具
- 实验性 AI 工具
- 需要特殊格式转换的工具
- 多配置文件需求

### 4.2 配置格式

```json
{
  "turboAiRules.adapters.custom": [
    {
      "name": "My Custom Tool",
      "targetFile": ".my-tool-rules",
      "template": "path/to/template.hbs",
      "enabled": true,
      "autoUpdate": true,
      "options": {
        "format": "json",
        "indent": 2
      }
    }
  ]
}
```

### 4.3 模板语法 (Handlebars)

支持使用 Handlebars 模板引擎定义自定义格式：

```handlebars
{{! template.hbs }}
# Rules for
{{toolName}}

Generated at:
{{timestamp}}

{{#each rules}}
  ##
  {{title}}

  {{content}}

  ---
{{/each}}
```

### 4.4 可用变量

- `rules`: 规则数组 (`ParsedRule[]`)
- `sources`: 规则源信息 (`RuleSource[]`)
- `timestamp`: 生成时间戳
- `toolName`: 工具名称
- `version`: 扩展版本

---

## 5. 规则转换流程

### 5.1 转换步骤

```
1. 获取合并后的规则列表
   ↓
2. 适配器过滤规则 (tags, priority)
   ↓
3. 适配器排序规则
   ↓
4. 适配器格式化内容
   ↓
5. 应用模板 (如果有)
   ↓
6. 添加元数据注释
   ↓
7. 返回最终内容
```

### 5.2 过滤策略

- **按标签过滤**: 只包含特定标签的规则
- **按优先级过滤**: 高于指定阈值的规则
- **按来源过滤**: 只包含指定规则源的规则
- **自定义过滤**: 适配器实现自定义逻辑

### 5.3 排序策略

- **按优先级排序**: 数值越高越靠前
- **按来源排序**: 按规则源添加顺序
- **按字母排序**: 按规则标题字母顺序
- **自定义排序**: 适配器实现自定义逻辑

---

## 6. 规则源标记设计（单文件部分更新支持）

### 6.1 问题背景

对于**单文件适配器**（如 Copilot 的 `copilot-instructions.md`），当一个适配器的规则来自多个规则源时，如果用户只想更新某个规则源的规则，系统需要能够：

1. 识别文件中哪些内容来自哪个规则源
2. 精确替换目标规则源的内容，保留其他内容
3. 保留用户手动添加的内容

### 6.2 标记格式设计

使用 **HTML 注释标记** 来标识每条规则的边界和来源：

```markdown
<!-- Generated by Turbo AI Rules at 2025-12-03T10:00:00.000Z -->
<!-- Total rules: 5 | Sources: team-rules, personal-rules -->

# GitHub Copilot Instructions

<!-- BEGIN_SOURCE source="team-rules" count="3" -->

<!-- BEGIN_RULE source="team-rules" id="typescript-naming" priority="high" -->

## TypeScript Naming Convention

Use camelCase for variables and functions...

<!-- END_RULE -->

<!-- BEGIN_RULE source="team-rules" id="logging" priority="medium" -->

## Logging Standards

Use structured logging with appropriate levels...

<!-- END_RULE -->

<!-- END_SOURCE source="team-rules" -->

<!-- BEGIN_SOURCE source="personal-rules" count="2" -->

<!-- BEGIN_RULE source="personal-rules" id="error-handling" priority="high" -->

## Error Handling

Always use try-catch for async operations...

<!-- END_RULE -->

<!-- END_SOURCE source="personal-rules" -->

<!-- BEGIN_USER_CONTENT -->

## My Custom Notes

This content was manually added and will be preserved.

<!-- END_USER_CONTENT -->
```

### 6.3 标记说明

| 标记                                      | 说明                                           |
| ----------------------------------------- | ---------------------------------------------- |
| `BEGIN_SOURCE` / `END_SOURCE`             | 规则源区块边界，包含该源的所有规则             |
| `BEGIN_RULE` / `END_RULE`                 | 单条规则边界，包含 sourceId、ruleId、priority  |
| `BEGIN_USER_CONTENT` / `END_USER_CONTENT` | 用户手动添加的内容区域（可选，被保护不会覆盖） |

### 6.4 标记属性

- `source`: 规则源 ID（必需）
- `id`: 规则 ID（必需）
- `priority`: 规则优先级（可选）
- `count`: 区块内规则数量（仅 SOURCE 标记）

### 6.5 部分更新流程

```
┌─────────────────────────────────────────────────────────────┐
│  部分更新流程（只更新指定规则源）                            │
├─────────────────────────────────────────────────────────────┤
│  1. 读取现有配置文件                                        │
│  2. 解析 BEGIN_SOURCE/END_SOURCE 标记，提取区块             │
│  3. 识别要更新的规则源区块                                   │
│  4. 保留其他规则源区块和用户内容                             │
│  5. 生成新的目标规则源区块                                   │
│  6. 按规则源顺序重新组装文件                                 │
│  7. 写回文件                                                │
└─────────────────────────────────────────────────────────────┘
```

### 6.6 实现要点

**解析器**:

```typescript
interface SourceBlock {
  sourceId: string;
  startLine: number;
  endLine: number;
  rules: RuleBlock[];
  rawContent: string;
}

interface RuleBlock {
  sourceId: string;
  ruleId: string;
  priority?: string;
  startLine: number;
  endLine: number;
  rawContent: string;
}

// 解析函数签名
function parseSourceBlocks(content: string): SourceBlock[];
function parseUserContent(content: string): string | null;
```

**生成器**:

```typescript
// 生成带标记的规则内容
function generateMarkedRuleContent(rule: ParsedRule): string;

// 生成带标记的规则源区块
function generateSourceBlock(sourceId: string, rules: ParsedRule[]): string;

// 合并区块（部分更新）
function mergeSourceBlocks(
  existingBlocks: SourceBlock[],
  newBlocks: SourceBlock[],
  targetSourceIds: string[],
): string;
```

### 6.7 目录适配器的处理

对于**目录适配器**（如 Cursor 的 `.cursor/rules/`），每条规则是独立文件，天然支持部分更新：

- 文件名可包含规则源前缀：`{sourceId}--{ruleId}.mdc`
- 或在 frontmatter 中标记 `sourceId`
- 删除/更新时按 sourceId 过滤文件

### 6.8 兼容性考虑

- 旧版本生成的文件（无标记）：全量覆盖
- 新版本生成的文件（有标记）：支持部分更新
- 标记使用 HTML 注释，不影响 AI 工具解析
- 用户手动编辑标记区域外的内容会被保留

---

## 7. 冲突处理

### 7.1 规则冲突

当多个规则源包含相同 ID 的规则时：

- **priority 策略**: 高优先级覆盖低优先级
- **merge 策略**: 合并规则内容（需适配器支持）
- **skip-duplicates 策略**: 保留第一个，跳过重复

### 7.2 配置冲突

当多个适配器生成相同目标文件时：

- 提示用户配置错误
- 拒绝生成并记录错误
- 建议用户修改配置

### 7.3 冲突标记

在生成的配置文件中添加注释标记冲突来源：

```markdown
<!-- Conflict Detected: Rule 'typescript-strict' from multiple sources -->
<!-- Priority: typescript-official (10) > typescript-team (5) -->
```

---

## 8. 性能优化

### 8.1 模板缓存

- 编译后的模板缓存到内存
- 避免重复编译
- 支持模板热更新

### 8.2 增量生成

- 检测规则是否有变化
- 只有变化时才重新生成
- 保留未变化的配置文件

### 8.3 并行生成

- 多个适配器并行生成配置
- 使用 Promise.all 提高效率
- 控制并发数避免资源耗尽

---

## 9. 错误处理

### 9.1 错误类型

- **TAI-4001**: 生成目标文件失败（权限/磁盘空间）
- **TAI-4002**: 文件覆盖冲突（用户手动修改）
- **TAI-4003**: 模板渲染错误（语法错误）

### 9.2 错误恢复

- 生成失败时保留原文件
- 临时文件清理
- 记录详细日志供排查

### 9.3 用户反馈

- 提示具体错误原因
- 提供修复建议
- 支持跳过失败继续处理其他适配器

---

## 10. 扩展机制

### 10.1 适配器插件

未来可支持适配器插件机制：

- 独立 npm 包
- 通过配置安装和启用
- 热加载和卸载
- 沙箱执行

### 10.2 适配器市场

可建立适配器市场：

- 社区贡献的适配器
- 评分和评论
- 自动更新
- 安全审核

### 10.3 API 稳定性

- 适配器接口遵循语义化版本
- 主版本升级保持向后兼容
- 提供迁移指南

---

> **返回**: [01-design.md](./01-design.md) - 产品整体设计
