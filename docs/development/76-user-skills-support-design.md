# 用户自定义 Skill 支持设计

| Property | Value |
|----------|-------|
| 文档类型 | 架构设计 |
| 创建日期 | 2026-01-26 |
| 设计目标 | 支持用户在本地创建自定义 skill |

---

## 一、问题背景

### 1.1 当前限制

**缺少用户 skill 目录**
- 系统只提供 `ai-rules/` 目录用于用户规则
- Skills 适配器默认不读取用户内容
- 用户无法方便地创建自定义 skill

**skill 来源不清晰**
- 用户创建的 skill 和远程同步的 skill 混在一起
- 清理逻辑难以区分用户内容和远程内容
- 缺少明确的所有权标识

**用户体验问题**
- 没有明确的"如何创建自定义 skill"指导
- 目录结构不够直观
- 与规则的管理方式不一致

### 1.2 为什么需要独立目录

**职责分离**
- 规则（rules）和技能（skills）是不同的概念
- 规则通常是编码规范、最佳实践等指导性内容
- 技能是可执行的工具、脚本、流程等

**清晰的所有权**
- 独立目录明确标识用户创建的内容
- 清理时可以准确识别需要保留的内容
- 避免误删用户创建的 skill

**一致的用户体验**
- 与 `ai-rules/` 目录形成对称的设计
- 用户可以用类似的方式管理规则和技能
- 降低学习成本

---

## 二、设计方案

### 2.1 核心思想

**新增 `ai-skills/` 目录，与 `ai-rules/` 并列**

这个目录专门用于存放用户创建的 skill，与远程同步的 skill 分离管理。

### 2.2 设计原则

| 原则 | 说明 | 目的 |
|------|------|------|
| **分离关注点** | 规则和 skill 使用不同目录 | 职责清晰 |
| **清晰的所有权** | `ai-skills/` 明确属于用户 | 避免误操作 |
| **一致的逻辑** | 与 `ai-rules/` 类似的工作方式 | 降低学习成本 |
| **零配置** | 默认行为即可工作 | 简化使用 |

---

## 三、架构设计

### 3.1 目录结构

```
workspace/
├── ai-rules/                    # 用户规则目录
│   ├── my-rule.md
│   └── team-conventions.md
│
├── ai-skills/                   # 用户 skill 目录（新增）
│   ├── simple-tool.md           # 单文件 skill
│   ├── my-tool/                 # 目录 skill（完整套装）
│   │   ├── skill.md             # 必须有 skill.md
│   │   └── helper.py            # 可包含工具文件
│   └── data-processor/
│       ├── skill.md
│       └── scripts/
│
├── rules/                       # 远程规则缓存（系统管理）
│   └── source-id/
│       └── ...
│
└── .skills/                     # Skills 输出目录（系统管理）
    ├── remote-skill-1/          # 远程同步的 skill
    ├── remote-skill-2/
    ├── simple-tool.md           # 单文件 skill（来自 ai-skills/）
    ├── my-tool/                 # 目录 skill（来自 ai-skills/）
    │   ├── skill.md
    │   └── helper.py
    └── data-processor/
        ├── skill.md
        └── scripts/
```

**设计说明**：
- `ai-rules/` 和 `ai-skills/` 是用户内容区，用户完全控制
- `rules/` 和 `.skills/` 是系统管理区，由扩展自动维护
- 输出目录 `.skills/` 合并远程和用户的 skill

### 3.2 配置结构

**新增顶层配置**：
- `userSkills.directory` - 用户 skill 目录路径
- 默认值：`ai-skills`
- 可自定义为其他路径

**适配器行为**：
- 自动读取 `ai-skills/` 目录
- 识别单文件（`.md`）和目录形式（`skill.md`）
- 与远程 skill 合并输出到 `.skills/`（目录型适配器，outputType: directory）
- 目录形式完整复制（包括工具文件等）

---

## 四、工作流程

### 4.1 用户创建自定义 skill

**单文件方式**：
1. 在 `ai-skills/` 创建 `my-tool.md`
2. 保存文件，扩展自动检测
3. 自动输出到 `.skills/my-tool.md`

**目录方式**（推荐，用于完整工具套装）：
1. 在 `ai-skills/` 创建目录（如 `my-tool/`）
2. 创建 `skill.md` 和其他工具文件
3. 保存后自动完整复制到 `.skills/my-tool/`

**结果**：
- 用户的 skill 和远程的 skill 都出现在 `.skills/` 目录
- AI 工具可以同时使用这两类 skill
- 目录形式可包含完整工具套装（脚本、配置等）

### 4.2 同步和清理

**同步远程 skill 时**：
- 从 Git 仓库拉取 skill
- 写入 `.skills/` 输出目录
- **保留** `ai-skills/` 来源的 skill 目录

**清理输出目录时**：
- 识别哪些目录来自 `ai-skills/`
- 清理时排除这些目录
- 只清理远程同步的 skill

**为什么这样设计**：
- 用户内容受保护，不会被清理逻辑误删
- 远程 skill 可以安全更新，不影响用户 skill
- 清理逻辑简单：根据来源位置判断

---

## 五、设计优势

### 5.1 与 ai-rules/ 对比

| 特性 | ai-rules/ | ai-skills/ |
|------|-----------|-----------|
| **用途** | 用户规则 | 用户 skill |
| **文件格式** | 单文件 .md 或目录形式 | 单文件 .md 或目录形式 |
| **sourceId** | user-rules | user-skills |
| **适配器类型** | isRuleType: true | isRuleType: false |
| **适配器输出** | 单文件或目录（取决于配置） | 单文件或目录（取决于配置） |
| **保护策略** | 单文件：block markers<br>目录：文件一致性检查 | 单文件：block markers<br>目录：文件一致性检查 |

### 5.2 核心优势

**清晰的分离**
- 规则和 skill 使用不同目录，职责明确
- 用户一眼就能看出哪里存放什么内容

**一致的逻辑**
- 与 `ai-rules/` 类似的工作方式
- 用户容易理解和使用

**明确的所有权**
- `ai-skills/` 中的内容明确属于用户
- 系统不会自动修改或删除

**简单的清理**
- 通过目录位置区分用户和远程 skill
- 清理逻辑简单可靠

**零配置**
- 默认行为即可工作
- 无需额外设置

---

## 六、测试场景

### 6.1 基本场景

**场景 1：创建用户 skill**
- 操作：在 ai-skills/ 创建 skill.md 或目录
- 预期：保存后自动输出包含用户 skill

**场景 2：合并远程和用户 skill**
- 操作：同步远程 skill，ai-skills/ 中有用户 skill
- 预期：两者正确合并输出，无冲突

**场景 3：清理保护**
- 操作：清理输出目录
- 预期：保留 ai-skills/ 来源的 skill，只删除远程 skill

### 6.2 边界场景

**场景 4：同名 skill 处理**
- 条件：用户和远程都有 my-skill/
- 预期：按优先级合并（用户优先）

**场景 5：空目录处理**
- 条件：ai-skills/ 为空
- 预期：不影响远程 skill 输出

**场景 6：自定义目录名**
- 操作：修改 userSkills.directory 配置
- 预期：功能正常工作，使用新的目录路径

**场景 7：多源同步**
- 条件：多个远程源都有 skill
- 预期：所有远程 skill 与用户 skill 正确合并

---

## 七、迁移影响

### 7.1 现有用户

**无影响**
- 不使用 skill 的用户无任何变化
- 现有配置继续正常工作

**向后兼容**
- 不破坏现有功能
- 可以选择性地使用新功能

### 7.2 新用户

**更清晰**
- 规则和 skill 明确分离
- 目录结构一目了然

**更简单**
- 零配置即可使用
- 学习成本低

---

## 八、总结

### 8.1 问题与解决方案

**问题**：用户无法方便地创建自定义 skill

**解决方案**：新增 `ai-skills/` 目录，与 `ai-rules/` 并列

### 8.2 设计价值

- ✅ 清晰分离规则和 skill
- ✅ 一致的用户体验
- ✅ 简单的清理逻辑
- ✅ 零配置即用
- ✅ 向后兼容
