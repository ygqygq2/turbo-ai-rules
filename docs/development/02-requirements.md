# 需求分析

> 本文档定义 Turbo AI Rules 扩展的功能需求、非功能需求和约束条件。

---

## 1. 用户故事

### 1.1 个人开发者

**场景 1: 快速应用规则模板**

- **作为** 个人开发者
- **我想** 在新项目中快速应用已验证的编码规则
- **以便** 不必每次手动编写或复制规则文件

**场景 2: 多项目规则统一**

- **作为** 维护多个项目的开发者
- **我想** 在所有项目中使用相同的编码规则
- **以便** 保持代码风格和 AI 行为一致

**场景 3: 规则自动更新**

- **作为** 订阅开源规则库的开发者
- **我想** 自动获取规则更新
- **以便** 始终使用最新的最佳实践

### 1.2 团队协作

**场景 4: 团队规范统一**

- **作为** 团队技术负责人
- **我想** 集中管理和分发团队编码规范
- **以便** 确保所有成员使用统一的 AI 提示规则

**场景 5: 规则版本控制**

- **作为** 团队管理者
- **我想** 追踪规则的变更历史
- **以便** 在出现问题时能够回滚到稳定版本

**场景 6: 多源规则合并**

- **作为** 团队成员
- **我想** 同时使用公司规范和开源规则
- **以便** 既遵守团队规范又利用社区最佳实践

### 1.3 企业组织

**场景 7: 企业级规则管理**

- **作为** 企业架构师
- **我想** 在组织内集中管理 AI 编码规则
- **以便** 确保所有项目符合企业标准

**场景 8: 安全与合规**

- **作为** 安全管理员
- **我想** 控制 AI 工具的行为边界
- **以便** 防止生成不合规或不安全的代码

---

## 2. 功能需求

### 2.1 核心功能（必须实现）

#### FR-01: 规则源管理

- **FR-01.1**: 添加 Git 规则源（HTTP/HTTPS/SSH）
- **FR-01.2**: 配置认证方式（无认证/Personal Token/SSH Key）
- **FR-01.3**: 删除规则源
- **FR-01.4**: 启用/禁用规则源
- **FR-01.5**: 编辑规则源配置（URL、分支、子路径）
- **FR-01.6**: 查看规则源详情（规则数量、最后同步时间等）

**验收标准**:

- 支持公共和私有仓库
- 支持指定分支和子目录
- 配置持久化存储
- 验证 Git URL 有效性

#### FR-02: 规则同步

- **FR-02.1**: 手动触发全量同步
- **FR-02.2**: 定时自动同步（可配置间隔）
- **FR-02.3**: 启动时自动同步
- **FR-02.4**: 增量更新（仅拉取变更）
- **FR-02.5**: 显示同步进度和状态
- **FR-02.6**: 同步失败时提供错误提示

**验收标准**:

- 同步操作不阻塞 UI
- 支持取消正在进行的同步
- 记录同步日志
- 多源并行同步

#### FR-03: 规则选择

- **FR-03.1**: 侧边栏树视图复选框选择
- **FR-03.2**: Webview 可视化选择器
- **FR-03.3**: 文件树视图选择
- **FR-03.4**: 按标签过滤规则
- **FR-03.5**: 全文搜索规则
- **FR-03.6**: 批量选择/取消选择
- **FR-03.7**: 选择状态持久化

**验收标准**:

- 三种选择方式实时同步
- 选择状态在重启后保持
- 搜索结果高亮显示
- 支持正则表达式搜索

#### FR-04: 配置生成

- **FR-04.1**: 生成 Cursor 配置文件 (`.cursorrules`)
- **FR-04.2**: 生成 GitHub Copilot 配置 (`.github/copilot-instructions.md`)
- **FR-04.3**: 生成 Continue.dev 配置 (`.continuerules`)
- **FR-04.4**: 支持自定义适配器（Handlebars 模板）
- **FR-04.5**: 配置文件覆盖提示
- **FR-04.6**: 生成前验证规则有效性

**验收标准**:

- 生成的配置文件格式正确
- 支持多规则合并
- 处理规则冲突（基于优先级）
- 可配置输出路径

#### FR-05: 规则浏览

- **FR-05.1**: 侧边栏显示规则源和规则列表
- **FR-05.2**: 查看规则详细内容
- **FR-05.3**: 显示规则元数据（标题、标签、优先级等）
- **FR-05.4**: 统计规则数量和分布
- **FR-05.5**: 规则内容语法高亮

**验收标准**:

- 树视图支持折叠/展开
- 规则内容使用 Webview 渲染
- 显示规则来源信息
- 支持 Markdown 格式渲染

### 2.2 辅助功能（应该实现）

#### FR-06: 冲突解决

- **FR-06.1**: 检测多源规则冲突
- **FR-06.2**: 提供冲突解决策略（优先级、手动选择）
- **FR-06.3**: 显示冲突详情
- **FR-06.4**: 规则去重

**验收标准**:

- 自动检测同名或重复规则
- 提供可视化冲突列表
- 支持用户自定义冲突策略

#### FR-07: 命令与快捷操作

- **FR-07.1**: 命令面板快速访问所有功能
- **FR-07.2**: 右键菜单快捷操作
- **FR-07.3**: 状态栏显示同步状态
- **FR-07.4**: 通知提示重要事件

**验收标准**:

- 所有主要功能有对应命令
- 符合 VSCode 交互习惯
- 通知可配置（启用/禁用）

#### FR-08: 规则验证

- **FR-08.1**: 验证 frontmatter 格式
- **FR-08.2**: 验证必填字段
- **FR-08.3**: 验证字段值范围
- **FR-08.4**: 显示验证错误详情

**验收标准**:

- 同步时自动验证
- 生成配置前验证
- 提供详细错误提示

### 2.3 高级功能（可选实现）

#### FR-09: 统计与分析

- **FR-09.1**: 规则使用统计
- **FR-09.2**: 规则源热度分析
- **FR-09.3**: 可视化仪表板

#### FR-10: 导入导出

- **FR-10.1**: 导出配置为 JSON/YAML
- **FR-10.2**: 导入配置
- **FR-10.3**: 分享配置给团队

#### FR-11: 规则模板

- **FR-11.1**: 提供常用规则模板
- **FR-11.2**: 创建自定义模板
- **FR-11.3**: 模板市场（未来）

---

## 3. 非功能需求

### 3.1 性能需求

- **NFR-01**: 扩展激活时间 < 2 秒
- **NFR-02**: 规则同步不阻塞 UI
- **NFR-03**: 搜索 1000 条规则 < 500ms
- **NFR-04**: 配置生成 < 1 秒
- **NFR-05**: 内存占用 < 100MB（正常使用）

**实现策略**:

- 全局缓存避免重复下载
- 增量同步减少数据传输
- 规则索引加速搜索
- 异步操作防止阻塞

### 3.2 可用性需求

- **NFR-06**: 新手 5 分钟内完成首次配置
- **NFR-07**: 所有操作有明确反馈
- **NFR-08**: 错误提示包含解决建议
- **NFR-09**: 支持中英文界面
- **NFR-10**: 遵循 VSCode 设计规范

**实现策略**:

- 提供向导式首次配置
- 友好的错误提示（含错误码）
- 国际化支持（i18n）
- 使用 VSCode 原生组件

### 3.3 安全性需求

- **NFR-11**: Git 凭据加密存储
- **NFR-12**: 日志不包含敏感信息（Token、密码）
- **NFR-13**: 路径验证防止目录穿越
- **NFR-14**: 输入验证防止注入攻击
- **NFR-15**: 本地存储，不上传用户数据

**实现策略**:

- 使用 VSCode Secrets API 存储凭据
- 日志脱敏处理
- 路径规范化和白名单验证
- 输入清理和校验

### 3.4 可维护性需求

- **NFR-16**: 代码测试覆盖率 ≥ 80%
- **NFR-17**: 模块化设计，单一职责
- **NFR-18**: API 文档完整（JSDoc）
- **NFR-19**: 错误日志完整可追溯
- **NFR-20**: 遵循 TypeScript 严格模式

**实现策略**:

- 单元测试 + 集成测试
- 分层架构设计
- 统一日志库（@ygqygq2/vscode-log）
- 错误码体系（TAI-xxxx）

### 3.5 兼容性需求

- **NFR-21**: 支持 VSCode 1.80+
- **NFR-22**: 支持 Windows/macOS/Linux
- **NFR-23**: 支持 Git 2.0+
- **NFR-24**: 不与其他扩展冲突

**实现策略**:

- 使用 VSCode API 稳定版本
- 跨平台路径处理
- 使用 simple-git 抽象 Git 操作

### 3.6 扩展性需求

- **NFR-25**: 支持自定义适配器
- **NFR-26**: 支持自定义规则格式（未来）
- **NFR-27**: 提供扩展 API（未来）
- **NFR-28**: 插件机制（未来）

**实现策略**:

- 适配器使用 Handlebars 模板
- 预留扩展点和接口
- 语义化版本管理

---

## 4. 用户界面需求

### 4.1 侧边栏视图

- 规则源树视图（支持复选框）
- 规则列表（分组显示）
- 状态指示（同步中、已选择等）
- 右键菜单（刷新、删除、查看详情）

### 4.2 Webview 界面

- 欢迎页面（首次使用引导）
- 规则选择器（卡片式布局）
- 规则详情查看器（Markdown 渲染）
- 统计仪表板（图表展示）

### 4.3 命令面板

- 所有主要功能有对应命令
- 命令分类清晰（turboAiRules.\*）
- 支持模糊搜索

### 4.4 状态栏

- 显示同步状态
- 显示已选规则数量
- 点击打开快捷菜单

---

## 5. 约束条件

### 5.1 技术约束

- 必须使用 TypeScript 开发
- 基于 VSCode Extension API
- 使用 simple-git 操作 Git
- 打包使用 esbuild
- 测试框架: Vitest（单元）+ Mocha（集成）

### 5.2 业务约束

- 规则源必须是 Git 仓库
- 规则格式固定为 MDC（Markdown + YAML Frontmatter）
- 不在本地编辑规则，保持与源同步
- 所有数据本地存储，不上传云端

### 5.3 设计约束

- 遵循"约定优于配置"原则
- 默认配置覆盖 80% 使用场景
- 渐进式揭示复杂功能
- 保持与 VSCode 原生体验一致

### 5.4 资源约束

- 开发周期: 渐进式开发
- 维护成本: 最小化
- 文档要求: 完整且持续更新

---

## 6. 需求优先级

### P0（必须实现）

- FR-01: 规则源管理
- FR-02: 规则同步
- FR-03: 规则选择
- FR-04: 配置生成
- NFR-01~NFR-15: 性能、可用性、安全性

### P1（应该实现）

- FR-05: 规则浏览
- FR-06: 冲突解决
- FR-07: 命令与快捷操作
- FR-08: 规则验证
- NFR-16~NFR-24: 可维护性、兼容性

### P2（可选实现）

- FR-09: 统计与分析
- FR-10: 导入导出
- FR-11: 规则模板
- NFR-25~NFR-28: 扩展性

---

> **相关文档**:
>
> - [01-background.md](./01-background.md) - 项目背景和设计目标
> - [03-design.md](./03-design.md) - 产品整体设计
> - [20-architecture.md](./20-architecture.md) - 架构设计
