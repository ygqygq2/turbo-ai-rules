# 存储策略设计

> 本文档描述 Turbo AI Rules 的数据存储策略、目录结构和文件管理方案。

---

## 1. 存储策略概述

### 1.1 三层存储模型

Turbo AI Rules 采用三层存储策略，平衡性能、安全和用户体验：

```
┌───────────────────────────────────────────────────────┐
│          Layer 1: 全局缓存 (Global Cache)             │
│  位置: ~/.cache/.turbo-ai-rules/sources/              │
│  作用: 多项目共享规则源                              │
│  生命周期: 手动清理                                 │
└───────────────────────────────────────────────────────┘
                          ↓
┌───────────────────────────────────────────────────────┐
│       Layer 2: 项目本地 (Project Local)              │
│  位置: <workspace>/.ai-rules/                        │
│  作用: 项目特定的规则索引和缓存                     │
│  生命周期: 随项目删除                              │
└───────────────────────────────────────────────────────┘
                          ↓
┌───────────────────────────────────────────────────────┐
│        Layer 3: AI 工具配置 (AI Configs)              │
│  位置: .cursorrules, .github/copilot-instructions.md 等        │
│  作用: 各 AI 工具直接读取的配置                     │
│  生命周期: 自动生成和更新                          │
└───────────────────────────────────────────────────────┘
```

---

## 2. 全局缓存 (Global Cache)

### 2.1 目录结构

````
~/.cache/.turbo-ai-rules/
└── sources/                          # 规则源缓存根目录
    ├── source-id-1/                  # 规则源 1 (目录名为 sourceId)
    │   ├── .git/                     # Git 仓库元数据
    │   ├── rules/                    # 规则文件目录（按源仓库结构）
    │   │   ├── typescript.mdc
    │   │   └── react.mdc
    │   └── meta.json                 # 规则源元数据（gitUrl/branch/subPath/lastSyncedAt/schemaVersion）
    ├── source-id-2/
    └── ...
```### 2.2 设计原理

- **共享性**: 多项目共享规则源，避免重复克隆
- **持久性**: 用户手动清理，扩展卸载后保留
- **隔离性**: 每个规则源独立目录，互不影响

### 2.3 缓存清理策略

- 手动清理命令: `turbo-ai-rules.clearCache`
- 提示清理时机: 磁盘空间不足、同步失败
- 清理粒度: 支持单个源或全部清理

---

## 3. 项目本地 (Project Local)

### 3.1 目录结构

````

<workspace>/
├── .ai-rules/ # 项目本地规则目录
│ ├── registry.json # 启用的规则源登记（源引用与策略）
│ ├── index/ # 解析索引（扩展内部使用）
│ │ ├── rules.index.json # 扁平化规则索引（ParsedRule[] 摘要）
│ │ └── search.index.json # 快速搜索索引
│ ├── generated/ # 生成物清单（可见产物的指纹与策略）
│ │ └── manifest.json # 目标文件校验和、生成时间、策略
│ └── cache/ # 扩展内部缓存（LRU 等）
└── .gitignore # 自动添加 .ai-rules/

````

### 3.2 设计原理

- **项目隔离**: 每个项目独立配置，互不影响
- **内部使用**: `.ai-rules/` 为扩展内部目录，默认不供用户编辑；用户可通过命令清理
- **按需同步**: 解析索引与生成清单按需增量更新，减少 IO
- **版本控制**: 自动添加到 .gitignore，不提交到 Git（仅保留可见生成物在仓库根目录）

### 3.3 索引文件（示意）

- `registry.json`

```json
{
  "schemaVersion": 1,
  "sources": [
    { "sourceId": "typescript-rules", "enabled": true, "branch": "main", "priority": 10 }
  ],
  "conflictResolution": "priority",
  "lastSync": "2025-01-23T10:00:00Z"
}
````

- `index/rules.index.json`

```json
{
  "schemaVersion": 1,
  "count": 128,
  "rules": [
    {
      "id": "ts-best-practices",
      "title": "TypeScript 最佳实践",
      "sourceId": "typescript-rules",
      "hash": "..."
    }
  ]
}
```

- `generated/manifest.json`

```json
{
  "schemaVersion": 1,
  "artifacts": [
    {
      "path": ".github/copilot-instructions.md",
      "sha256": "...",
      "policy": "overwrite",
      "generatedAt": "2025-01-23T10:00:00Z"
    }
  ]
}
```

---

## 4. AI 工具配置 (AI Configs)

### 4.1 生成的文件列表

| AI 工具        | 配置文件路径                      | 格式     |
| -------------- | --------------------------------- | -------- |
| Cursor         | `.cursorrules`                    | Markdown |
| GitHub Copilot | `.github/copilot-instructions.md` | Markdown |
| Continue.dev   | `.continuerules`                  | Markdown |
| 自定义工具     | 用户指定路径                      | 可配置   |

### 4.2 文件生成策略

- **原子写入**: 先写临时文件，成功后重命名
- **备份机制**: 覆盖前备份原有文件（`.bak` 后缀）
- **元数据注释**: 文件头部添加生成信息和时间戳
- **冲突处理**: 检测用户手动修改，提示是否覆盖
- **指纹与清单**: 采用 `.ai-rules/generated/manifest.json` 记录生成物及其校验和与策略

### 4.3 元数据注释示例

```markdown
<!--
  Auto-generated by Turbo AI Rules
  Generated at: 2025-01-23T10:00:00Z
  Sources: typescript-rules, react-best-practices
  Conflict Resolution: priority

  ⚠️ This file is auto-generated and will be overwritten on sync.
  ⚠️ To preserve custom rules, add them to .ai-rules/user-rules/
-->

# Your AI Assistant Rules

...
```

---

## 5. .gitignore 管理

### 5.1 自动添加规则

扩展自动在项目根目录的 `.gitignore` 中添加：

```gitignore
# Turbo AI Rules - Auto-generated
.ai-rules/
```

### 5.2 管理策略

- **智能检测**: 检查是否已存在相同规则
- **分段标记**: 使用注释标记扩展添加的规则
- **用户控制**: 配置项 `autoGitignore` 可关闭自动添加
- **手动移除**: 卸载扩展时提示是否移除规则

### 5.3 配置项

```json
{
  "turboAiRules.storage.autoGitignore": true,
  "turboAiRules.storage.gitignoreMarker": "# Turbo AI Rules - Auto-generated"
}
```

---

## 6. 性能优化

### 6.1 缓存策略

- **解析缓存**: LRU 缓存最近解析的 100 个规则文件
- **索引缓存**: 内存中缓存规则索引，避免重复读取
- **增量同步**: 只拉取 Git 更新，不重新克隆

### 6.2 文件操作优化

- **批量写入**: 使用事务机制批量写入文件
- **延迟写入**: 防抖后统一写入，减少 IO 操作
- **并行处理**: 多个规则源并行克隆和解析（限制 3 个并发）

### 6.3 磁盘空间管理

- **监控空间**: 检测可用空间，不足时提示清理
- **自动清理**: 可选的自动清理过期缓存（默认关闭）
- **压缩存储**: 长期不用的规则源可压缩存储

---

## 7. 安全与权限

### 7.1 路径安全

- **路径规范化**: 使用 `path.normalize()` 和 `path.resolve()`
- **边界检查**: 确保所有路径在工作区或缓存目录内
- **防穿越攻击**: 拒绝包含 `..` 的路径

### 7.2 文件权限

- **只读模式**: 全局缓存默认只读，防止误修改
- **权限检查**: 写入前检查目录和文件权限
- **原子操作**: 使用 `fs-extra.move()` 确保原子性

### 7.3 敏感数据保护

- **首选 Secret**: Git Token 建议存储在 VS Code Secret Storage（`context.secrets`）
- **用户设置可选**: 如用户明确选择将 Token 存于用户配置（Settings），需在 UI 明示安全风险
- **项目文件检测**: 检测到项目内配置文件出现 Token 或可疑凭据字段时，展示安全提醒并给出迁移到 Secret 的指引（不自动读取/上报内容）
- **日志脱敏**: 日志中不输出凭据与敏感路径
- **临时文件清理**: 异常退出时清理临时文件

---

## 8. 跨平台兼容性

### 8.1 路径处理

- **分隔符**: 使用 `path.sep` 和 `path.join()` 处理路径
- **大小写**: Windows 路径不区分大小写，需规范化
- **长路径**: Windows 长路径支持（`\\?\` 前缀）

### 8.2 权限处理

- **执行权限**: Linux/macOS 检查执行权限
- **文件锁**: Windows 文件锁机制差异处理
- **符号链接**: 跨平台符号链接支持

### 8.3 环境变量

- **主目录**: 使用 `os.homedir()` 获取用户主目录
- **临时目录**: 使用 `os.tmpdir()` 获取临时目录
- **环境检测**: 根据 `process.platform` 调整行为

---

> **返回**: [01-design.md](./01-design.md) - 产品整体设计

---

## 9. Webview 与扩展通信（指引）

> 详见《07-webview-best-practices》，此处给出与存储/同步相关的通信约定（设计指引层面）。

### 9.1 消息信封（Envelope）

- 基本结构：

```json
{
  "id": "uuid",
  "type": "sources.sync",
  "payload": { "sourceId": "..." },
  "meta": { "schemaVersion": 1, "panelId": "search" }
}
```

- 类型命名：`domain.action`（如 `sources.add`、`rules.search`、`sync.start`）
- 兼容性：`meta.schemaVersion` 用于协议升级兼容

### 9.2 请求/响应与错误

- 响应结构：

```json
{ "id": "uuid", "ok": true, "data": {} }
```

- 错误结构（统一错误码）：

```json
{
  "id": "uuid",
  "ok": false,
  "error": { "code": "TAI-2002", "message": "克隆失败", "hint": "请检查网络或访问凭据" }
}
```

### 9.3 长任务进度与取消

- 进度事件：`type: "progress"`，`payload: { id, phase, percent, message }`
- 取消机制：`type: "cancel"` + `payload: { id }`，扩展端应支持可取消的同步/解析

### 9.4 订阅模式（快照 + 变更）

- `getAndSubscribe`：首次返回快照（如当前索引/状态），随后通过 `rules.updated`、`sync.status` 推送变更
- 用途：搜索结果、同步状态、当前源详情等需要实时刷新的 UI

### 9.5 安全约束

- 严禁在消息中传递 Token/敏感信息
- 对用户输入做转义/校验，前端遵循 CSP，资源 URI 必须通过 `webview.asWebviewUri` 转换

### 9.6 与存储的一致性

- Webview 只通过消息访问数据；一切持久化变更由扩展端落盘到 `.ai-rules/` 与可见生成物
- 可见生成物的更新以 `manifest.json` 为准，更新完成后广播状态事件以驱动 UI 刷新
