# 自定义适配器设计

> **文档状态**: 活跃维护  
> **对应代码**: `src/adapters/CustomAdapter.ts`  
> **最后更新**: 2025-01-05

---

## 概述

自定义适配器（CustomAdapter）是 Turbo AI Rules 的通用输出引擎，支持灵活的规则输出配置。用户可以配置多个自定义适配器，将规则输出为不同格式和位置。

### 核心特性

- **多输出模式**: 支持单文件模式和目录模式
- **灵活过滤**: 基于文件扩展名过滤规则
- **源组织**: 支持按源 ID 组织或平铺结构
- **自动索引**: 目录模式可自动生成索引文件
- **优先级排序**: 单文件模式按优先级排序规则

---

## 配置结构

### 必需字段

- **id**: 唯一标识符（kebab-case 格式）
- **name**: 显示名称
- **enabled**: 是否启用此适配器
- **autoUpdate**: 同步后是否自动更新
- **outputPath**: 输出路径（相对工作区根目录）
- **outputType**: 输出类型（file 或 directory）

### 可选字段

- **fileExtensions**: 文件扩展名过滤列表（如 ['.md', '.mdc']）
  - 不配置或为空：同步所有文件
  - 配置后：只同步匹配的文件
  
- **organizeBySource**: 是否按源 ID 组织子目录（仅 directory 模式）
  
- **generateIndex**: 是否生成索引文件（仅 directory 模式）
  
- **indexFileName**: 索引文件名（默认 index.md）

---

## 输出模式

### 单文件模式

将所有规则合并到单个文件。

**适用场景**: 需要单一配置文件的 AI 工具

**特点**:
- 自动生成元数据头部（包含源信息、规则数量、更新时间）
- 按优先级排序规则（high → medium → low）
- 每条规则包含完整元信息（tags、source、priority）
- 规则之间用分隔线分开

**输出结构**:
- 头部注释（元数据）
- 文件标题和说明
- 规则列表（按优先级排序）

### 目录模式

将规则输出为目录结构。

**适用场景**: 需要规则文件分离的场景

#### 按源组织模式

**目录结构**:
```
rules/
├── index.md              # 索引文件（可选）
├── company-rules/
│   ├── ts-naming-001.md
│   ├── react-hooks-002.md
│   └── ...
└── personal-rules/
    ├── api-design-001.md
    └── ...
```

**特点**:
- 每个源 ID 有独立子目录
- 规则文件以 `{rule-id}.md` 命名
- 索引文件按源分组展示

#### 平铺模式

**目录结构**:
```
rules/
├── index.md                     # 索引文件（可选）
├── company-rules-ts-naming-001.md
├── company-rules-react-hooks-002.md
├── personal-rules-api-design-001.md
└── ...
```

**特点**:
- 所有规则文件平铺在同一目录
- 文件名格式：`{source-id}-{rule-id}.md`
- 避免文件名冲突

---

## 文件过滤机制

### 过滤规则

**未配置 fileExtensions**:
- 同步所有规则文件，不做任何过滤

**配置了 fileExtensions**:
- 只同步源文件扩展名匹配的规则
- 检查规则的 `filePath` 字段
- 支持多个扩展名（如 ['.md', '.mdc']）

### 应用场景

1. **只要 Markdown 规则**: `fileExtensions: ['.md']`
2. **包含 MDC 规则**: `fileExtensions: ['.md', '.mdc']`
3. **所有规则**: 不配置 `fileExtensions`

---

## 配置示例说明

### 示例 1: 默认 rules 目录

最简单的配置，向后兼容旧版本。

**配置说明**:
- 输出到 `rules/` 目录
- 按源组织子目录
- 生成索引文件
- 不过滤文件类型

### 示例 2: 单文件输出

将规则合并到单个配置文件。

**配置说明**:
- 输出到 `.my-ai-tool.md`
- 只包含 .md 和 .mdc 文件
- 按优先级排序

### 示例 3: 多适配器配置

同时配置多个输出目标。

**配置说明**:
- rules 目录：目录模式，按源组织
- windsurf 工具：单文件模式，只要 .md 文件
- docs/ai-rules：目录模式，平铺结构，生成 README.md 索引

---

## 类层次结构

```
BaseAdapter (抽象基类)
├── CursorAdapter (内置)
├── CopilotAdapter (内置)
├── ContinueAdapter (内置)
└── CustomAdapter (通用自定义适配器)
    ├── 文件模式: 合并所有规则到单个文件
    └── 目录模式: 按源或平铺组织多个文件
```

---

## 核心功能说明

### 文件模式功能

1. 规则过滤（基于 fileExtensions）
2. 优先级排序
3. 元数据生成
4. 内容合并
5. 文件写入

### 目录模式功能

1. 规则过滤（基于 fileExtensions）
2. 源分组（如果启用 organizeBySource）
3. 文件生成（每条规则一个文件）
4. 索引生成（如果启用 generateIndex）
5. 目录创建和文件写入

---

## 向后兼容

### 默认行为

扩展初始化时会检查配置：
- 如果用户没有配置任何自定义适配器
- 自动添加默认的 "default-rules" 适配器
- 行为等同于旧版本的 RulesAdapter

### 迁移路径

用户可以：
1. 保持默认配置（零配置使用）
2. 修改默认适配器的配置
3. 禁用默认适配器
4. 添加新的自定义适配器

---

## 配置验证

### 验证规则

扩展加载时会验证配置：
- **id 唯一性**: 不能有重复的 id
- **id 格式**: 必须是 kebab-case
- **outputPath 冲突**: 不同适配器的输出路径不能相同
- **必填字段**: id、name、outputPath、outputType 必须存在

### 错误处理

- 配置无效时显示警告通知
- 无效的适配器会被跳过
- 不影响其他正常的适配器运行

---

## 用户体验

### 开箱即用

- 无需配置即可使用
- 自动生成 `rules/` 目录
- 适合大多数使用场景

### 配置方式

1. 打开 VS Code 设置（Ctrl/Cmd + ,）
2. 搜索 "Turbo AI Rules"
3. 找到 "Custom Adapters" 配置项
4. 使用 JSON 编辑器添加/修改配置
5. 保存后自动生效（无需重启）

### 同步流程

1. 用户触发同步命令
2. 扩展同步所有规则源
3. 遍历启用的自定义适配器
4. 每个适配器根据配置生成输出
5. 更新 .gitignore（如需要）
6. 显示成功通知

---

## 用户自定义规则保护机制

### 设计理念

**职责分明原则**:
- 程序管理自动生成区域
- 用户管理自定义区域
- 互不干涉，明确边界

### 目录模式保护

**文件名前缀约定**:
- `000-799`: 自动生成区域（程序管理）
- `800-999`: 用户自定义区域（程序不碰）

**工作原理**:
- 同步时只删除/覆盖 000-799 前缀的文件
- 800-999 前缀的文件完全不受影响
- 无前缀文件保持不变（向后兼容）

**用户操作**:
创建自定义规则时使用 800-999 前缀，如：
- `820-team-overrides.mdc` (高优先级覆盖)
- `850-project-specific.mdc` (常规自定义)
- `900-code-review.mdc` (补充规则)

### 单文件模式保护

**块标记约定**:
- `<!-- TURBO-AI-RULES:BEGIN -->` 和 `<!-- TURBO-AI-RULES:END -->` 之间是自动生成区域
- 块标记之外的内容是用户自定义区域

**工作原理**:
- 同步时只替换块标记之间的内容
- 块标记外的内容完全保留（包括格式、空行、注释）
- 首次生成时会添加用户区域模板

**用户操作**:
在块标记外添加自定义规则，推荐在文件底部添加，使用醒目标题如 `# 🎯 我的自定义规则`。

### 优先级机制

不同 AI 工具的规则优先级机制不同：

- **Cursor**: 文件名数字越小优先级越高（社区经验，未官方确认）
- **GitHub Copilot**: 合并所有指令，冲突时行为不确定
- **Continue**: 按字典序加载，支持 alwaysApply
- **Windsurf/Aide**: 待确认

**保守策略**: 由于部分工具优先级未确认，建议用户在自定义规则中**显式声明优先级**和**覆盖说明**。

### 冲突处理

**目录模式**:
- 检测到用户文件在自动生成范围内
- 显示警告提示用户重命名
- 暂时跳过覆盖该文件

**单文件模式**:
- 检测到块内容被用户修改
- 询问用户：覆盖/备份修改/取消同步

---

## 未来扩展

### 模板系统

支持自定义输出模板（Handlebars/Mustache），允许用户完全控制输出格式。

### 后处理钩子

支持配置后处理脚本，在生成文件后执行自定义处理（如格式化、转换）。

### 高级过滤

支持更复杂的规则过滤条件：
- 按标签过滤（tags）
- 按优先级过滤（priority）
- 按源 ID 过滤（sourceIds）
- 组合条件过滤

---

## 实施状态

### 已完成

- ✅ 核心 CustomAdapter 类实现
- ✅ 文件模式和目录模式
- ✅ 文件过滤功能
- ✅ 配置验证
- ✅ 向后兼容处理
- ✅ 单元测试和集成测试

### 进行中

- ⏳ 用户规则保护机制（部分实现）
- ⏳ 配置界面优化

### 计划中

- 📋 模板系统
- 📋 后处理钩子
- 📋 高级过滤功能

---

**相关文档**:
- 用户指南: `docs/user-guide/02-configuration.md`
- 开发文档: `docs/development/01-design.md`
- 适配器设计: `docs/development/01-05-adapter-design.md`
